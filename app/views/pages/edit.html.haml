= content_for :menu_link do
  = render 'menu_link'

= content_for :page_editable do
  .row
    %h4.text-center
      %small URL:
      = "/#{@wiki_info.name}/"
      = text_field_tag :page, @page.url_name, placeholder: t('terms.page_name_format_placeholder'), id: 'edit-page-url-name', required: true

    %h3.text-center
      %small Page name:
      = text_field_tag :page, @page.name, placeholder: t('terms.page_name_format_placeholder'), id: 'edit-page-name', required: true

    #editing-user.label.label-warning.offset2{style: 'display: none;'}
    = render 'form'

    = subscribe_to "/pages/#{@page.id}"

  :coffeescript
    $ ->
      $('#edit-page-name').keyup ->
        $('#page_name').val( $('#edit-page-name').val())
      $('#edit-page-url-name').keyup ->
        $('#page_url_name').val( $('#edit-page-url-name').val())

      parse_md = ->
        result = Markdown get_markdown_text()
        $('#preview-result').html result
      get_markdown_text = ->
        $('#markdown-text').val()
      sending_page_body = (request_url, body) ->
        $.ajax
          type: "POST"
          url: request_url
          data:
            edited_user_id: "#{current_user.id}"
            body: body
          dataType: 'json'
        .error ->
          parse_md()

      prev = initial = get_markdown_text()
      $('#markdown-text').keyup ->
        $('#page-submit-btn').removeAttr("disabled").addClass("btn-primary")
        $('#editing-user').hide()
        markdown_text = get_markdown_text()
        unless prev == markdown_text
          prev = markdown_text
          sending_page_body "#{preview_page_path(wiki_name: @wiki_info.name, page_name: @page.url_name)}", markdown_text

      PrivatePub.subscribe "/pages/#{@page.id}", (data, channel) ->
        unless data.edited_user_id == "#{current_user.id}"
          $('#markdown-text').animate({borderColor: '#fbf300' }, 'slow')
          $('#markdown-text').val data.body
          result = Markdown $('#markdown-text').val()
          $('#preview-result').html result
          $('#editing-user').html(data.editing_word)
          $('#editing-user').show()
          $('#page-submit-btn').attr("disabled", "true").removeClass("btn-primary")
          $('#markdown-text').animate({borderColor: '#fff' }, 'slow')

      # parse on firstview
      parse_md()
